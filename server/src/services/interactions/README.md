
## Refactoring

- упростить в interactions.create параметр interaction - просто свойства в корень параметров

- добавить источник interactions, нужно чтобы можно было собрать собщения на конкретном плече

- переименовать в БД и коде
  - channel -> channel
  - userId -> user
  
- доработать валидацию вложенных структур ...не очень помню что именно не хватает, см. закоментированные фрагменты в схемах

## Interactions

### Создание и завершение

1.1 Создание interaction

1.2 Создание child interaction, с указанием parent и name

1.3 Успешное завершение interaction

1.4 Завершение с ошибкой

1.5 Отмена действия (cancel)

1.6 Перенос обработки на определенное время (processAt - UTC)

1.7 Перенос обработки на интерва времени (processIn - ms)

### Обработка потока

2.1 В тестовом режиме проверяем что next обрабатывает следующий interaction в очереди, который ещё не completed или cancelled, и у которых next_processing не в будущем

2.2 Если обработка успешная, то next_procrssing null.  Если ошибка то completed и failed true и поле error содержит причину.  Обработка в результате признаков completed, error и признаки repeate_at и repeate_in

2.3 Проверяем что работает ограничение на количество обработок в единицу времени

2.4 Проверяем что работает ограничение на количество одновременно обрабатываемых элементов

### "Не загруженный" сервис 

3.1 Если ничего нет, со смотрим есть ли в очереди элементы назначенные на определенное время.

3.2 Если нечего обрабатывать, то проверяем не появилось ли работа через интервал времени из конфигурации, или если он меньше интервал до следующей ожидаемой работы.

### Postgres PubSub

4.1 Получение сообщения от postges hook, что добавлен или изменено поле next_processing в конкретном interaction, с последющей попыткой выбрать элемент для работы, или определить через какое время надо попробовать его выбрать.

### Блокировка

5.1 При любом update, полю lock присваивается значение now()

5.2 Блокировка элемента на время обработки. И разблокировка после.

5.3 Продление блокировки если обработка затянулась

5.4 Прекращение блокировки по времени, если она не была снята

### Связанные interactions

6.1 При завершении interaction, устанавливаем next_processing parent, если есть в now

6.2 При завершении interaction, переводим не завершенные child interaction в cancelled

6.3 Получение child interaction по имени. Если несколько, то последний созданный.

6.4 Получение child interactions по имени. Список отсортированный по возрастанию created.

6.5 Если создается child interaction сразу в состоянии completed, то parent interaction ставится в очередь на обработку.

### Завершение работы

7.1 Завершение работы конкретной очереди обработки в сервисе data/interactions.  ожидание завершения через promise

--- 7.2 Завершение работы всего сервиса data/interactions, с акуратным завершением очередей

--- 7.3 Завершение работы всего сервиса data/interactions, с аварийным завершением очередей

### Обработка ошибок

8.1 При возникновении ошибки, ia ставится на повторную обработку через onErrorProcessingDelay

--- 8.2 Ограничение по времени, на обработку interaction, с последующим cancel его promise.  Время в конфигурации

### Bus

9.1 Информация что interaction создан

9.2 Что interaction завершен, успешно или с ошибкой

9.3 ? Что данные interaction изменены

### Message Id 

10.1 Сохранение и выбор interaction, с конкретным messageId
